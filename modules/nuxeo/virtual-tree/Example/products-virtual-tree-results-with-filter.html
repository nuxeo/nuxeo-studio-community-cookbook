<dom-module id="products-virtual-tree-results-with-filter">
  <template>
    <style include="nuxeo-styles">
      :host {
        display: block;
      }
      .results {
        @apply --layout-vertical;
        @apply --layout-flex;
        --nuxeo-results-view-height: var(
          --nuxeo-document-content-height,
          var(--nuxeo-document-content-min-height, calc(100vh - 216px - var(--nuxeo-app-top))
        ));
        margin-bottom: var(--nuxeo-document-content-margin-bottom, 0);
      }
      .results.dragging {
        border: 2px dashed var(--nuxeo-primary-color);
      }
      .ellipsis {
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
        display: block;
        width: calc(100% - 38px);
      }
      .capitalize {
        text-transform: capitalize;
      }
      nuxeo-tag {
        margin-right: 2px;
      }
      nuxeo-justified-grid {
        height: calc(100vh - 10em);
      }

      /* Filter panel */
      .filters-header {
        @apply --layout-horizontal;
        @apply --layout-center;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
        padding: 0.4em 0.6em;
        /*background: var(--nuxeo-page-background, #f5f5f5);*/
        /*border: 1px solid var(--nuxeo-border, #d9d9d9);*/
        border-radius: 4px;
        margin: 4px 0 6px;
        transition: background .15s;
      }
      .filters-header:hover {
        background: var(--nuxeo-hover-color, #ececec);
      }
      .filters-header iron-icon {
        margin-right: 6px;
      }
      .filters-body {
        border: 1px solid var(--nuxeo-border, #d9d9d9);
        border-radius: 4px;
        padding: 0.6em 0.8em 0.8em;
        margin-bottom: 10px;
        background: var(--nuxeo-box-background, #fff);
      }
      .filters-body > *:last-child {
        margin-bottom: 0;
      }

      #searchInput {
        width: 400px;
      }
    </style>

    <nuxeo-page-provider
      id="nxProvider"
      provider="ProductsVirtualTreePageProvider"
      page-size="40"
      aggregations="{{aggregations}}"
      enrichers="thumbnail, permissions"
      params="[[params]]"
      schemas="dublincore,common,uid,file,product,company"
      headers='{"X-NXfetch-document":"properties","X-NXtranslate-directoryEntry":"label"}'
      fetch-aggregates>
    </nuxeo-page-provider>

    <!-- Collapsible Filter Section -->
    <div
      class="filters-header"
      role="button"
      tabindex="0"
      aria-controls="filtersCollapse"
      aria-expanded$="[[filtersOpen]]"
      on-tap="_toggleFilters"
      on-keydown="_toggleFiltersKey">
      <iron-icon icon="[[_toggleIcon(filtersOpen)]]"></iron-icon>
      <span>Filter</span>
    </div>
    <iron-collapse id="filtersCollapse" opened="[[filtersOpen]]">
      <div class="filters-body" >
        <nuxeo-input
          role="widget"
          id="searchInput"
          type="search"
          label="[[i18n('defaultSearch.fullText')]]"
          value="{{fulltext}}"
          placeholder=""
          autofocus
          on-keydown="_checkForEnter">
        </nuxeo-input>

        <!-- More search widget -->
      </div>
    </iron-collapse>
    
    <nuxeo-results
      id="results"
      display-mode="table"
      name="[[document.uid]]"
      nx-provider="[[nxProvider]]"
      selected-items="{{selectedItems}}"
      document="[[document]]"
      display-quick-filters
      display-sort="[[_canSort(document, sortOptions)]]"
      sort-options="[[sortOptions]]"
      role="widget">

      <nuxeo-data-grid
        name="grid"
        icon="nuxeo:view-thumbnails"
        class="results"
        selection-enabled
        draggable$="[[_hasWritePermission(document)]]"
        drop-target-filter="[[_dropTargetFilter]]">
        <template>
          <nuxeo-document-grid-thumbnail
            class="grid-box"
            tabindex$="[[tabIndex]]"
            selected$="[[selected]]"
            index="[[index]]"
            doc="[[item]]"
            on-navigate="_navigate"
            selected-items="[[selectedItems]]">
          </nuxeo-document-grid-thumbnail>
        </template>
      </nuxeo-data-grid>

      <nuxeo-data-table
        role="widget"
        class="results"
        selection-enabled
        on-row-clicked="_navigate"
        draggable$="[[_hasWritePermission(document)]]"
        drop-target-filter="[[_dropTargetFilter]]"
        icon="nuxeo:view-list"
        name="table">

        <nuxeo-data-table-column
          name="[[i18n('documentContentView.datatable.header.title')]]"
          field="dc:title"
          sort-by="[[_displaySort(document, 'dc:title')]]"
          filter-by="title"
          flex="100">
          <template>
            <nuxeo-document-thumbnail document="[[item]]"></nuxeo-document-thumbnail>
            <a class="title ellipsis" href$="[[urlFor(item)]]" on-tap="_navigate">[[item.title]]</a>
          </template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="Type" field="product:type" sort-by="product:type">
          <template>[[item.properties.product:type]]</template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="City" field="company:city" sort-by="company:city">
          <template>[[item.properties.company:city]]</template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="Country" field="company:country" sort-by="company:country">
          <template>[[item.properties.company:country]]</template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="Name" field="company:name" sort-by="company:name">
          <template>[[item.properties.company:name]]</template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.type')]]" field="type" hidden>
          <template><nuxeo-tag>[[item.type]]</nuxeo-tag></template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column
          name="[[i18n('documentContentView.datatable.header.modified')]]"
          field="dc:modified"
          sort-by="[[_displaySort(document, 'dc:modified')]]"
          filter-by="dc_modified_agg"
          flex="50">
          <template is="header">
            <nuxeo-dropdown-aggregation
              placeholder="[[i18n('documentContentView.datatable.header.modified')]]"
              data="[[aggregations.dc_modified_agg]]"
              value="{{column.filterValue}}"
              multiple>
            </nuxeo-dropdown-aggregation>
          </template>
          <template>
            <nuxeo-date datetime="[[item.properties.dc:modified]]"></nuxeo-date>
          </template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column
          name="[[i18n('documentContentView.datatable.header.lastContributor')]]"
          filter-by="dc_last_contributor_agg"
          field="dc:lastContributor"
          sort-by="[[_displaySort(document, 'dc:lastContributor')]]"
          flex="50">
          <template is="header">
            <nuxeo-dropdown-aggregation
              placeholder="[[i18n('documentContentView.datatable.header.lastContributor')]]"
              data="[[aggregations.dc_last_contributor_agg]]"
              value="{{column.filterValue}}"
              multiple>
            </nuxeo-dropdown-aggregation>
          </template>
          <template>
            <nuxeo-user-tag user="[[item.properties.dc:lastContributor]]"></nuxeo-user-tag>
          </template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.state')]]" field="currentLifeCycleState" hidden>
          <template><span class="capitalize">[[formatLifecycleState(item.state)]]</span></template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.version')]]" field="versionLabel" hidden>
          <template>[[formatVersion(item)]]</template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column
          name="[[i18n('documentContentView.datatable.header.created')]]"
          field="dc:created"
          sort-by="[[_displaySort(document, 'dc:created')]]"
          flex="50"
          hidden>
          <template><nuxeo-date datetime="[[item.properties.dc:created]]"></nuxeo-date></template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.author')]]" field="dc:creator" sort-by="[[_displaySort(document, 'dc:creator')]]" hidden>
          <template><nuxeo-user-tag user="[[item.properties.dc:creator]]"></nuxeo-user-tag></template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.nature')]]" field="dc:nature" hidden>
          <template>
            <nuxeo-tag hidden$="[[!item.properties.dc:nature]]">
              [[formatDirectory(item.properties.dc:nature)]]
            </nuxeo-tag>
          </template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.coverage')]]" field="dc:coverage" hidden>
          <template>
            <nuxeo-tag hidden$="[[!item.properties.dc:coverage]]">
              [[formatDirectory(item.properties.dc:coverage)]]
            </nuxeo-tag>
          </template>
        </nuxeo-data-table-column>

        <nuxeo-data-table-column name="[[i18n('documentContentView.datatable.header.subjects')]]" field="dc:subjects" hidden flex="60">
          <template>
            <template is="dom-repeat" items="[[item.properties.dc:subjects]]" as="subject">
              <nuxeo-tag>[[formatDirectory(subject)]]</nuxeo-tag>
            </template>
          </template>
        </nuxeo-data-table-column>

      </nuxeo-data-table>

    </nuxeo-results>
  </template>

  <script>
    Polymer({
      is: 'products-virtual-tree-results-with-filter',
      behaviors: [Nuxeo.DocumentContentBehavior],
      properties: {
        document: {
          type: Object
        },
        params: {
          type: Object,
          observer: '_onParamsChanged'
        },
        fulltext: {
          type: String,
          value: null
        },
        filtersOpen: {
          type: Boolean,
          value: false
        }
      },

      _onParamsChanged(newValue, prevValue) {
        console.log('_onParamsChanged:', newValue);
        this.$.results.fetch();
      },

      _checkForEnter(e) {
        if (this.params && e.key === 'Enter') {
          const newParams = Object.assign({}, this.params);
          if (this.fulltext) {
            newParams.system_fulltext = this.fulltext;
          } else {
            newParams.system_fulltext = null;
          }
          this.set('params', newParams); // triggers _onParamsChanged
        }
      },

      _toggleIcon: function(opened) {
        return 'hardware:keyboard-arrow-' + (opened ? 'up' : 'down');
      },

      _toggleFilters() {
        this.filtersOpen = !this.filtersOpen;
      }
    });
  </script>
</dom-module>